<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pengaturan & Indexing - DeepFace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body class="layout-body">
    <header class="layout-header">
      <div class="header-logo">
        <img src="png/telkomsat.png" alt="Telkomsat" />
      </div>
    </header>

    <aside class="layout-sidebar">
      <a href="main.html" class="sidebar-link">
        <img src="png/absen.png" alt="Absensi" class="sidebar-icon" />
        Absensi Wajah
      </a>

      <a href="data.html" class="sidebar-link">
        <img src="png/data.png" alt="Data Absensi" class="sidebar-icon" />
        Data Absensi Hari Ini
      </a>

      <a href="data_collector.html" class="sidebar-link">
        <img src="png/collector.png" alt="Data Collector" class="sidebar-icon" />
        Data Collector
      </a>

      <a href="settings.html" class="sidebar-link active">
        <img src="png/database.png" alt="Settings" class="sidebar-icon" />
        Pengaturan & Indexing
      </a>
    </aside>

    <main class="layout-main container-card">
      <div class="content-header">
        <h2>Pengaturan Sistem & Database Wajah</h2>
        <button id="reloadButton" class="btn-refresh bg-yellow-500 hover:bg-yellow-600">
          Sinkronisasi Database
        </button>
      </div>

      <div id="statusArea" class="status-area">Memuat data wajah terdaftar...</div>

      <div class="grid grid-cols-2 gap-4 mb-8">
        <div class="p-4 border rounded-lg shadow-md bg-white">
          <h3 class="font-semibold text-lg mb-2 text-blue-600">Reset Log Absensi Harian</h3>
          <p class="text-sm text-gray-600 mb-3">Absensi akan otomatis direset oleh sistem setiap pukul **17:00** sore. Tidak diperlukan reset manual.</p>
          <div class="bg-blue-100 text-blue-700 font-bold py-2 px-4 rounded-md w-full text-center">
            RESET OTOMATIS AKTIF
          </div>
        </div>
        <div class="p-4 border rounded-lg shadow-md bg-white">
          <h3 class="font-semibold text-lg mb-2 text-blue-600">Jalankan Indexing Manual</h3>
          <p class="text-sm text-gray-600 mb-3">Jalankan skrip **`python -m backend.index_data`** di terminal Anda untuk memproses wajah baru.</p>
          <button onclick="alert('Instruksi: Silakan jalankan perintah python -m backend.index_data di terminal Anda. (Pastikan Anda sudah mengambil minimal 10 gambar di Data Collector)')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md w-full transition duration-300">
            Lihat Instruksi
          </button>
        </div>
      </div>

      <h3 class="font-semibold text-xl mb-4 text-gray-800">Daftar Wajah Terdaftar di Sistem</h3>
      <div class="table-container">
        <table class="min-w-full">
          <thead>
            <tr>
              <th>No.</th>
              <th>Nama</th>
              <th>Jumlah Gambar</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="facesTableBody">
            </tbody>
        </table>
      </div>
    </main>

    <footer class="layout-footer">
      &copy; 2025 Telkomsat Bogor
    </footer>

    <script>
      const API_BASE_URL = "http://127.0.0.1:8000";
      const statusArea = document.getElementById("statusArea");
      const facesTableBody = document.getElementById("facesTableBody");
      const reloadButton = document.getElementById("reloadButton");
      
      function updateStatus(message, type = "info") {
        const map = {
          success: "status-area bg-green-100 text-green-700",
          error: "status-area bg-red-100 text-red-700",
          warning: "status-area bg-yellow-100 text-yellow-700",
          info: "status-area bg-gray-100 text-gray-700",
        };
        statusArea.className = map[type] || "status-area";
        statusArea.innerHTML = message;
      }
      
      async function reloadDB() {
        updateStatus("Melakukan sinkronisasi database...");
        try {
            const res = await fetch(`${API_BASE_URL}/reload_db`, { method: 'POST' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            updateStatus(`Sinkronisasi Berhasil! Total ${data.total_faces} wajah unik terindeks.`, "success");
            fetchRegisteredFaces();
        } catch (error) {
            updateStatus(`Gagal sinkronisasi DB: ${error.message}`, "error");
        }
      }

      async function fetchRegisteredFaces() {
        updateStatus("Memuat daftar wajah...");
        facesTableBody.innerHTML = '<tr><td colspan="4">Memuat...</td></tr>';

        try {
          const response = await fetch(`${API_BASE_URL}/list_faces`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          renderTable(data.faces);
          updateStatus(`Total ${data.faces.length} wajah unik terdaftar. (Ini adalah daftar intern yang sudah memiliki gambar dataset)`, "info");
        } catch (error) {
          console.error("Error:", error);
          updateStatus(`Gagal terhubung ke server API: ${error.message}`, "error");
          facesTableBody.innerHTML = '<tr><td colspan="4" class="text-red-500">Gagal memuat data.</td></tr>';
        }
      }
      
      async function deleteFace(name) {
          if (!confirm(`Anda yakin ingin menghapus data wajah untuk ${name} secara permanen? Menghapus akan menghapus semua file gambar dan vektor dari database.`)) return;
          
          updateStatus(`Menghapus data wajah untuk ${name}...`, "warning");
          
          try {
              const res = await fetch(`${API_BASE_URL}/delete_face/${name}`, { method: 'DELETE' });
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              
              const data = await res.json();
              updateStatus(data.message, data.status === 'success' ? 'success' : 'error');
              fetchRegisteredFaces(); // Muat ulang daftar
              
          } catch (error) {
              updateStatus(`Gagal menghapus wajah: ${error.message}`, "error");
          }
      }
      

      function renderTable(faces) {
        facesTableBody.innerHTML = faces.map((item, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${item.name}</td>
            <td>${item.count} Gambar</td>
            <td>
              <button onclick="deleteFace('${item.name}')" class="text-red-500 hover:text-red-700 font-medium text-sm">Hapus Permanen</button>
            </td>
          </tr>`).join("");
      }

      window.onload = () => {
        fetchRegisteredFaces();
        reloadButton.addEventListener("click", reloadDB);
      };
    </script>
  </body>
</html>