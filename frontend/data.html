<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Absensi Hari Ini - DeepFace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body class="layout-body">
    <header class="layout-header">
      <div class="header-logo">
        <img src="png/telkomsat.png" alt="Telkomsat" />
      </div>
    </header>

    <aside class="layout-sidebar">
      <a href="main.html" class="sidebar-link">
        <img src="png/absen.png" alt="Absensi" class="sidebar-icon" />
        Absensi Wajah
      </a>

      <a href="data.html" class="sidebar-link active">
        <img src="png/data.png" alt="Data Absensi" class="sidebar-icon" />
        Data Absensi Hari Ini
      </a>

      <a href="data_collector.html" class="sidebar-link">
        <img src="png/collector.png" alt="Data Collector" class="sidebar-icon" />
        Data Collector
      </a>

      <a href="settings.html" class="sidebar-link">
        <img src="png/database.png" alt="Settings" class="sidebar-icon" />
        Pengaturan & Indexing
      </a>
    </aside>

    <main class="layout-main container-card">
      <div class="content-header">
        <h2>Data Absensi Hari Ini</h2>
        <button id="refreshDataBtn" class="btn-refresh bg-blue-500 hover:bg-blue-600">
          Refresh Data
        </button>
      </div>

      <div id="statusArea" class="status-area">Memuat data absensi...</div>

      <div id="photoUrlInfo" class="text-sm text-gray-500 mb-4 break-words hidden"></div>

      <div class="table-container">
        <table class="min-w-full">
          <thead>
            <tr>
              <th>No.</th>
              <th>Nama</th>
              <th>Instansi</th>
              <th>Kategori</th>
              <th>Status Absen</th>
              <th>Waktu Absen Terakhir</th>
              <th>Jarak Vektor</th>
              <th>Foto</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody">
            </tbody>
        </table>
      </div>
    </main>

    <footer class="layout-footer">
      &copy; 2025 Telkomsat Bogor
    </footer>

    <script>
      const API_BASE_URL = "http://127.0.0.1:8000";
      const statusArea = document.getElementById("statusArea");
      const attendanceTableBody = document.getElementById("attendanceTableBody");
      const refreshDataBtn = document.getElementById("refreshDataBtn");
      const photoUrlInfo = document.getElementById("photoUrlInfo");
      
      function updateStatus(message, type = "info") {
        const map = {
          success: "status-area bg-green-100 text-green-700",
          error: "status-area bg-red-100 text-red-700",
          loading: "status-area bg-blue-100 text-blue-700",
          info: "status-area bg-gray-100 text-gray-700",
        };
        statusArea.className = map[type] || "status-area";
        statusArea.innerHTML = message;
      }
      
      async function fetchAttendanceData() {
        updateStatus("Memuat data absensi terbaru...", "loading");
        attendanceTableBody.innerHTML = '<tr><td colspan="8">Memuat...</td></tr>';
        
        photoUrlInfo.classList.add("hidden");
        photoUrlInfo.innerHTML = '';

        try {
          const response = await fetch(`${API_BASE_URL}/attendance/today`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          renderTable(data);
          
          if (data.length > 0) {
             updateStatus(`Berhasil memuat ${data.length} entri absensi hari ini.`, "success");
             
             const firstEntryUrl = data[0].image_path;
             if(firstEntryUrl) {
                photoUrlInfo.innerHTML = `URL Foto (Contoh): <a href="${firstEntryUrl}" target="_blank">${API_BASE_URL}${firstEntryUrl}</a>`;
                photoUrlInfo.classList.remove("hidden");
             }
          } else {
             updateStatus("Belum ada data absensi yang tercatat hari ini.", "info");
          }

        } catch (error) {
          console.error("Error:", error);
          updateStatus(`Gagal terhubung ke server API atau memuat data: ${error.message}`, "error");
          attendanceTableBody.innerHTML = '<tr><td colspan="8" class="text-red-500">Gagal memuat data.</td></tr>';
        }
      }
      
      function renderTable(attendanceData) {
        if (attendanceData.length === 0) {
            attendanceTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">Belum ada absensi hari ini.</td></tr>';
            return;
        }

        attendanceTableBody.innerHTML = attendanceData.map((item, i) => {
            
            // --- LOGIKA BARU UNTUK WARNA STATUS ---
            const statusText = item.status; // Contoh: "MASUK (Terlambat)"
            let statusClass = 'text-gray-500';
            
            // Logika untuk menandai keterlambatan/pulang cepat
            if (statusText.includes("Terlambat") || statusText.includes("Cepat")) {
                 statusClass = 'text-red-600'; // Merah untuk masalah waktu
            } else if (statusText.includes("Tepat Waktu")) {
                 statusClass = 'text-green-600'; // Hijau untuk tepat waktu
            }
            // -------------------------------------
            
            const timeDisplay = item.timestamp; 
            const photoUrl = item.image_path ? `${API_BASE_URL}${item.image_path}` : '#';

            return `
              <tr>
                <td>${i + 1}</td>
                <td>${item.name}</td>
                <td>${item.instansi}</td>
                <td>${item.kategori}</td>
                <td class="${statusClass} font-semibold">${statusText}</td>
                <td>${timeDisplay} WIB</td>
                <td>N/A</td>
                <td>
                  ${item.image_path ? `<a href="${photoUrl}" target="_blank" class="text-blue-500 hover:text-blue-700">Lihat</a>` : 'N/A'}
                </td>
              </tr>`;
        }).join("");
      }

      window.onload = () => {
        fetchAttendanceData();
        refreshDataBtn.addEventListener("click", fetchAttendanceData);
      };
    </script>
  </body>
</html>